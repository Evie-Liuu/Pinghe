import{_ as ne,a as ie,b as re,c as ue,d as de,e as ge,f as ve,g as _e,h as ce,i as me,j as pe,k as be,l as fe,m as xe,n as he,o as ke,p as ye,q as we,r as Ce,s as Le,t as Se,u as Te,v as Be,w as Me,x as Ee,y as $e,z as De,A as Ue,B as Ie,C as He,D as Ae,E as Re}from"./平和國小_mobile_Example-xpo9UaZU.js";import{B as Oe,u as je,r as g,c as D,k as ze,l as j,D as Fe,C as Ne,a as n,o as i,b as t,d,f as U,g as I,h as z,i as Pe,s as Ve,t as x,q as u,F as L,p as S,n as v,e as T,v as B,A as Ge}from"./index-BEoggM0d.js";import{i as We,u as qe}from"./useDateFormat-Dmwa79A0.js";import{s as F}from"./SDGs_goal-BU-5yG0n.js";import{C as Je}from"./CJKSub-DVPa7WD_.js";import{N as Ke,n as Qe,m as Xe,u as Ye,i as Ze,a as et,b as tt,c as st,E as lt}from"./index-B-Vy3el1.js";var at=/(?:^|\s)(!\[(.+|:?)]\((\S+)(?:(?:\s+)["'](\S+)["'])?\))$/,ot=Ke.create({name:"image",addOptions(){return{inline:!1,allowBase64:!1,HTMLAttributes:{}}},inline(){return this.options.inline},group(){return this.options.inline?"inline":"block"},draggable:!0,addAttributes(){return{src:{default:null},alt:{default:null},title:{default:null},width:{default:null},height:{default:null}}},parseHTML(){return[{tag:this.options.allowBase64?"img[src]":'img[src]:not([src^="data:"])'}]},renderHTML({HTMLAttributes:m}){return["img",Xe(this.options.HTMLAttributes,m)]},addCommands(){return{setImage:m=>({commands:p})=>p.insertContent({type:this.name,attrs:m})}},addInputRules(){return[Qe({find:at,type:this.type,getAttributes:m=>{const[,,p,y,b]=m;return{src:y,alt:p,title:b}}})]}}),nt=ot;const it={class:"pt-25 w-full z-10 shadow-md bg-header text-rice-500"},rt={class:"container mx-auto flex items-center p-4"},ut={class:"w-1/3"},dt={class:"text"},gt={class:"max-w-4xl mx-auto p-4 pt-10 text-[1.2rem]"},vt={key:0,class:"animate-fade-in-up flex flex-col gap-8"},_t={class:"relative z-10 text-white"},ct={class:"text-4xl font-bold mb-4"},mt={class:"mb-2 text-lg"},pt={class:"flex flex-wrap gap-2 mt-2"},bt={class:"flex flex-col gap-4 items-start"},ft={class:"self-end flex gap-2"},xt=["innerHTML"],ht={key:1,class:"w-full"},kt={key:0,class:"border p-2 flex gap-2 rounded-t-md"},yt={class:"my-20"},wt={class:"flex flex-col gap-4 mb-6 text-black"},Ct={class:"font-bold"},Lt={class:"text-gray-800"},St={class:"flex items-center justify-end mt-2"},Tt=["onClick"],Bt={class:"ml-1"},Mt={key:1},Et={key:0,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 text-black"},$t={class:"bg-white p-6 rounded-md max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto"},Dt={class:"mb-4"},Ut={class:"relative flex flex-wrap items-center"},It={key:0,class:"absolute right-2 text-red-500"},Ht={key:0,class:"text-red-500 text-sm mt-1"},At={class:"mb-4"},Rt={class:"mb-4"},Ot=["value"],jt={class:"mb-4"},zt={class:"relative"},Ft=["innerHTML"],Nt=["onClick"],Pt=["placeholder"],Vt={key:0,class:"absolute right-2 text-red-500"},Gt=["onClick","innerHTML"],Wt={key:0,class:"px-3 py-2 text-gray-500"},qt={key:1,class:"text-red-500 text-sm mt-1"},Jt={class:"mb-4"},Kt={__name:"StoryDetail",props:{id:String},setup(m){const p=m,y=Ge("handleAppScroll"),{user:b,isTeacher:M}=je(),{formatDate:N}=qe(),a=g(null),w=g(null),f=g(!1),P=D(()=>{if(!a.value)return{};const s=a.value.cover_image_url||"Background_2.png";try{let e=null;return a.value.cover_image_url.startsWith("http")?e=a.value.cover_image_url:e=new URL(Object.assign({"../assets/images/Background_1.png":Re,"../assets/images/Background_1_B.png":Ae,"../assets/images/Background_1_F.png":He,"../assets/images/Background_2.png":Ie,"../assets/images/Background_Example.png":Ue,"../assets/images/Bar_Selected.png":De,"../assets/images/Bar_Unselected.png":$e,"../assets/images/LoadingTrain.png":Ee,"../assets/images/Logo.gif":Me,"../assets/images/MainPage_Background.png":Be,"../assets/images/MainPage_Background.webp":Te,"../assets/images/MainPage_Background_T.png":Se,"../assets/images/MainPage_Example.png":Le,"../assets/images/MainPage_Pic.png":Ce,"../assets/images/MainPage_Pic.webp":we,"../assets/images/Title.png":ye,"../assets/images/Train_Long.png":ke,"../assets/images/Train_Long_Full.png":he,"../assets/images/Train_Smoke.gif":xe,"../assets/images/Train_Smoke_W.gif":fe,"../assets/images/figure1.png":be,"../assets/images/figure2.png":pe,"../assets/images/figure3.png":me,"../assets/images/figure4.png":ce,"../assets/images/figure5.png":_e,"../assets/images/lightBulb.png":ve,"../assets/images/lightBulb2.png":ge,"../assets/images/logo.png":de,"../assets/images/logo_BW.png":ue,"../assets/images/story_bg.png":re,"../assets/images/student.png":ie,"../assets/images/平和國小_mobile_Example.png":ne})[`../assets/images/${s}`],import.meta.url).href,{backgroundImage:`url(${e})`}}catch{return{backgroundImage:`url(${new URL(""+new URL("Background_2-C9DmGNh3.png",import.meta.url).href,import.meta.url).href})`}}}),o=Ye({content:"",extensions:[Ze,et,tt.configure({nested:!0}),nt,st]});ze(async()=>{try{if(b.value){a.value=await j.getShowcase(b.value.institution_id,p.id),console.log(a.value);let s=await j.getShowcaseComments(b.value.institution_id,p.id);w.value=s.items,console.log(w.value)}}catch(s){console.error("Failed to fetch posts:",s),a.value=We.find(e=>e.post_id===p.id),console.log(a.value),w.value=a.value.comment}}),Fe(()=>{o.value&&o.value.destroy()});const V=()=>{o.value&&o.value.commands.setContent(a.value.content||""),f.value=!0},G=()=>{o.value&&(a.value.content=o.value.getHTML()),f.value=!1,console.log("內容已儲存:",o.value.getJSON()),alert("內容已儲存！")},W=()=>{o.value&&o.value.commands.setContent(a.value.content||""),f.value=!1},q=()=>{navigator.share?navigator.share({title:a.value.title,text:a.value.intro,url:window.location.href}).catch(console.error):(navigator.clipboard.writeText(window.location.href),alert("連結已複製到剪貼簿！"))},J={author_id:"0"},h=g(""),K=()=>{h.value.trim()!==""&&(a.value.comment.unshift({uuid:Date.now(),author_id:b.value.id,author_name:b.value.name,time:Date.now(),delete_time:null,text:h.value,likes:0,liked:!1}),h.value="")},Q=s=>{const e=a.value.comment.find(c=>c.uuid===s);e&&(e.liked?e.likes--:e.likes++,e.liked=!e.liked)},E=g(!1),r=g({...a.value}),k=g(""),C=g(!1),H=g(null),$=F.filter(s=>s.value!==0),A=D(()=>$.filter(s=>r.value.sdgs_goals.includes(s.value))),R=D(()=>k.value?$.filter(s=>s.title.toLowerCase().includes(k.value.toLowerCase())&&!r.value.sdgs_goals.includes(s.value)):$.filter(s=>!r.value.sdgs_goals.includes(s.value)));Ne(H,()=>{C.value=!1});const _=g({title:!1,tags:!1}),X=()=>{E.value=!1},Y=()=>{let s=!1;r.value.title.trim()||(_.value.title=!0,s=!0),r.value.sdgs_goals.length===0&&(_.value.tags=!0,s=!0),!s&&(a.value.title=r.value.title,a.value.intro=r.value.intro,a.value.time=r.value.time,a.value.types=r.value.sdgs_goals,a.value.cover_image_url=r.value.cover_image_url,E.value=!1)},Z=s=>{const e=s.target.files[0];e&&(r.value.cover_image_url=e.name)},ee=s=>{const e=new Date(s.target.value);r.value.time=Math.floor(e.getTime()/1e3)},te=s=>{r.value.sdgs_goals.includes(s.value)||r.value.sdgs_goals.push(s.value),k.value="",C.value=!1},se=s=>{const e=r.value.sdgs_goals.indexOf(s);e!==-1&&r.value.sdgs_goals.splice(e,1)},le=()=>{},ae=s=>{const e=s.target.files[0];if(e&&o.value){const c=URL.createObjectURL(e);o.value.chain().focus().setImage({src:c}).run()}s.target.value=""},oe=s=>{const e=s.target.files[0];if(e&&o.value){const c=URL.createObjectURL(e);o.value.chain().focus().extendMarkRange("link").setLink({href:c}).insertContent(e.name).run()}s.target.value=""};return(s,e)=>{const c=Pe("router-link");return i(),n("div",{class:"page-background content-scroller",onScroll:e[12]||(e[12]=(...l)=>u(y)&&u(y)(...l))},[t("header",it,[t("div",rt,[t("div",ut,[U(c,{to:"/story",class:"back-home-btn"},{default:I(()=>[t("span",dt,[U(Je,{align:"center"},{zh:I(()=>[...e[13]||(e[13]=[z("回上頁",-1)])]),en:I(()=>[...e[14]||(e[14]=[z("Return",-1)])]),_:1})]),e[15]||(e[15]=t("span",{class:"icon"},"←",-1))]),_:1})]),e[16]||(e[16]=t("div",{class:"w-1/3 text-center"},null,-1)),e[17]||(e[17]=t("div",{class:"w-1/3"},null,-1))])]),t("main",gt,[a.value?(i(),n("section",vt,[t("div",{style:Ve(P.value),class:"relative bg-cover bg-center bg-opacity-70 p-7 rounded-md md:h-80 grid grid-cols-1 content-end overflow-hidden"},[e[18]||(e[18]=t("div",{class:"absolute inset-0 bg-black/40"},null,-1)),t("div",_t,[t("h1",ct,x(a.value.title),1),t("p",mt,x(a.value.intro),1),t("small",null,x(u(N)(a.value.time*1e3)),1),t("div",pt,[(i(!0),n(L,null,S(a.value.types,l=>(i(),n("span",{key:l,class:"px-3 py-1 text-sm rounded-full bg-blue-100 text-blue-800"},x(u(F)[l].title.replace(/<br\s*\/?>/gi,"")),1))),128))])])],4),t("section",bt,[t("div",ft,[!f.value&&u(M)?(i(),n("button",{key:0,onClick:V,class:"bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600"}," 編輯內容 ")):d("",!0),f.value&&u(M)?(i(),n("button",{key:1,onClick:G,class:"bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600"}," 儲存 ")):d("",!0),f.value&&u(M)?(i(),n("button",{key:2,onClick:W,class:"bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600"}," 取消 ")):d("",!0),t("button",{onClick:q,class:"bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600"}," 分享 ")]),f.value?(i(),n("div",ht,[u(o)?(i(),n("div",kt,[t("button",{onClick:e[0]||(e[0]=l=>u(o).chain().focus().toggleHeading({level:1}).run()),class:v([{"is-active":u(o).isActive("heading",{level:1})},"p-2 rounded hover:bg-blue-200"]),title:"標題 1"}," H1 ",2),t("button",{onClick:e[1]||(e[1]=l=>u(o).chain().focus().toggleHeading({level:2}).run()),class:v([{"is-active":u(o).isActive("heading",{level:2})},"p-2 rounded hover:bg-blue-200"]),title:"標題 2"}," H2 ",2),t("button",{onClick:e[2]||(e[2]=l=>u(o).chain().focus().toggleHeading({level:3}).run()),class:v([{"is-active":u(o).isActive("heading",{level:3})},"p-2 rounded hover:bg-blue-200"]),title:"標題 3"}," H3 ",2),t("button",{onClick:e[3]||(e[3]=l=>u(o).chain().focus().toggleTaskList().run()),class:v([{"bg-blue-200":u(o).isActive("taskList")},"p-2 rounded hover:bg-blue-200"]),title:"待辦清單"},[...e[19]||(e[19]=[t("i",{class:"fa-solid fa-list-check"},null,-1)])],2),t("button",{onClick:e[4]||(e[4]=l=>u(o).chain().focus().toggleBulletList().run()),class:v([{"bg-blue-200":u(o).isActive("bulletList")},"p-2 rounded hover:bg-blue-200"]),title:"項目符號清單"},[...e[20]||(e[20]=[t("i",{class:"fa-solid fa-list-ul"},null,-1)])],2),t("button",{onClick:e[5]||(e[5]=l=>s.$refs.imageInput.click()),class:"p-2 rounded hover:bg-blue-200",title:"插入圖片"},[...e[21]||(e[21]=[t("i",{class:"fa-solid fa-image"},null,-1)])]),t("button",{onClick:e[6]||(e[6]=l=>s.$refs.fileInput.click()),class:"p-2 rounded hover:bg-blue-200",title:"插入檔案"},[...e[22]||(e[22]=[t("i",{class:"fa-solid fa-paperclip"},null,-1)])]),t("input",{ref:"imageInput",type:"file",accept:"image/*",onChange:ae,style:{display:"none"}},null,544),t("input",{ref:"fileInput",type:"file",onChange:oe,style:{display:"none"}},null,544)])):d("",!0),U(u(lt),{editor:u(o),class:"w-full prose max-w-none border-x border-b p-4 rounded-b-md overflow-hidden"},null,8,["editor"])])):(i(),n("div",{key:0,class:"prose max-w-none",innerHTML:a.value.content},null,8,xt))]),t("section",yt,[e[23]||(e[23]=t("h2",{class:"text-xl mb-4"},"留言板",-1)),t("div",wt,[(i(!0),n(L,null,S(w.value,l=>(i(),n("div",{key:l.uuid,class:v(["p-4 rounded-md",l.author_id===J.author_id?"bg-green-100":"bg-gray-100"])},[t("p",Ct,x(l.author_name),1),t("p",Lt,x(l.text),1),t("div",St,[t("button",{onClick:O=>Q(l.uuid),class:"text-gray-500 hover:text-red-500"},[t("i",{class:v(["fa-heart",l.liked?"fa-solid text-red-500":"fa-regular"])},null,2),t("span",Bt,x(l.likes),1)],8,Tt)])],2))),128))]),t("div",null,[T(t("textarea",{"onUpdate:modelValue":e[7]||(e[7]=l=>h.value=l),class:"w-full p-2 border rounded-md",rows:"3",placeholder:"在這裡寫下你的留言..."},null,512),[[B,h.value]]),t("button",{onClick:K,class:"mt-2 bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600"}," 發布留言 ")])])])):(i(),n("div",Mt,[...e[24]||(e[24]=[t("p",null,"找不到這篇故事。",-1)])]))]),E.value?(i(),n("div",Et,[t("div",$t,[e[33]||(e[33]=t("h2",{class:"text-xl mb-4"},"編輯故事",-1)),t("div",Dt,[e[26]||(e[26]=t("label",{class:"block text-lg font-medium mb-2"},"標題*",-1)),t("div",Ut,[T(t("input",{type:"text","onUpdate:modelValue":e[8]||(e[8]=l=>r.value.title=l),class:v(["w-full p-2 border border-gray-300 rounded-md",{"border-red-500":_.value.title}])},null,2),[[B,r.value.title]]),_.value.title?(i(),n("div",It,[...e[25]||(e[25]=[t("i",{class:"fa-solid fa-circle-exclamation"},null,-1)])])):d("",!0)]),_.value.title?(i(),n("p",Ht," 請輸入標題 ")):d("",!0)]),t("div",At,[e[27]||(e[27]=t("label",{class:"block text-lg font-medium mb-2"},"介紹",-1)),T(t("input",{type:"text","onUpdate:modelValue":e[9]||(e[9]=l=>r.value.intro=l),class:"w-full p-2 border border-gray-300 rounded-md"},null,512),[[B,r.value.intro]])]),t("div",Rt,[e[28]||(e[28]=t("label",{class:"block text-lg font-medium mb-2"},"時間",-1)),t("input",{type:"date",value:r.value.time?new Date(r.value.time*1e3).toISOString().split("T")[0]:"",onInput:ee,class:"w-full p-2 border border-gray-300 rounded-md"},null,40,Ot)]),t("div",jt,[e[30]||(e[30]=t("label",{class:"block text-lg font-medium mb-2"},"SDGs標籤*",-1)),t("div",zt,[t("div",{class:v(["relative flex flex-wrap items-center gap-1 p-2 border border-gray-300 rounded-md min-h-[2.5rem]",{"border-red-500":_.value.tags}])},[(i(!0),n(L,null,S(A.value,l=>(i(),n("span",{key:l.value,class:"inline-flex items-center px-2 py-1 text-sm bg-blue-500 text-white rounded-full"},[t("span",{innerHTML:l.title},null,8,Ft),t("button",{onClick:O=>se(l.value),class:"ml-1 text-white hover:text-gray-200"}," × ",8,Nt)]))),128)),T(t("input",{type:"text","onUpdate:modelValue":e[10]||(e[10]=l=>k.value=l),onFocus:e[11]||(e[11]=l=>C.value=!0),onInput:le,class:"flex-1 min-w-0 outline-none bg-transparent",placeholder:A.value.length===0?"搜尋SDGs標籤...":""},null,40,Pt),[[B,k.value]]),_.value.tags?(i(),n("div",Vt,[...e[29]||(e[29]=[t("i",{class:"fa-solid fa-circle-exclamation"},null,-1)])])):d("",!0)],2),C.value?(i(),n("div",{key:0,ref_key:"editDropdown",ref:H,class:"absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto mt-1"},[(i(!0),n(L,null,S(R.value,l=>(i(),n("div",{key:l.value,onClick:O=>te(l),class:"px-3 py-2 hover:bg-orange-300 cursor-pointer",innerHTML:l.title},null,8,Gt))),128)),R.value.length===0?(i(),n("div",Wt," 無匹配的標籤 ")):d("",!0)],512)):d("",!0),_.value.tags?(i(),n("p",qt," 請至少選擇一個SDGs標籤 ")):d("",!0)])]),t("div",Jt,[e[31]||(e[31]=t("label",{class:"block text-lg font-medium mb-2"},"背景圖片",-1)),t("input",{type:"file",onChange:Z,accept:"image/*",class:"w-full p-2 border border-gray-300 rounded-md"},null,32),e[32]||(e[32]=t("p",{class:"text-sm text-gray-500 mt-1"}," 選擇新圖片上傳，將替換現有背景圖片。 ",-1))]),t("div",{class:"flex justify-end gap-2"},[t("button",{onClick:X,class:"px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600"}," 取消 "),t("button",{onClick:Y,class:"px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600"}," 儲存 ")])])])):d("",!0)],32)}}},ss=Oe(Kt,[["__scopeId","data-v-03dc70dc"]]);export{ss as default};
