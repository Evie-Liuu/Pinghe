import{_ as ue,a as de,b as ge,c as ve,d as ce,e as _e,f as me,g as pe,h as be,i as fe,j as xe,k as he,l as ye,m as ke,n as we,o as Ce,p as Se,q as Le,r as Te,s as Be,t as Me,u as Ee,v as Ue,w as $e,x as De,y as Ie,z as He,A as Ae,B as Re,C as Oe,D as Pe,E as ze}from"./平和國小_mobile_Example-Bsr5Md9p.js";import{B as Fe,u as Ne,r as d,c as H,O as Ve,l as p,D as je,C as Ge,a,o,b as t,d as c,f as A,g as R,h as N,i as We,s as qe,t as _,q as u,F as B,p as M,n as b,e as E,v as U,A as Je}from"./index-BMdFWD3I.js";import{s as V}from"./SDGs_goal-BU-5yG0n.js";import{C as Ke}from"./CJKSub-CytIZdfj.js";import{u as Qe}from"./useDateFormat-Tij9gOpP.js";import{N as Xe,n as Ye,m as Ze,u as et,i as tt,a as st,b as lt,c as at,E as ot}from"./index-Bt3qDDDW.js";var nt=/(?:^|\s)(!\[(.+|:?)]\((\S+)(?:(?:\s+)["'](\S+)["'])?\))$/,it=Xe.create({name:"image",addOptions(){return{inline:!1,allowBase64:!1,HTMLAttributes:{}}},inline(){return this.options.inline},group(){return this.options.inline?"inline":"block"},draggable:!0,addAttributes(){return{src:{default:null},alt:{default:null},title:{default:null},width:{default:null},height:{default:null}}},parseHTML(){return[{tag:this.options.allowBase64?"img[src]":'img[src]:not([src^="data:"])'}]},renderHTML({HTMLAttributes:f}){return["img",Ze(this.options.HTMLAttributes,f)]},addCommands(){return{setImage:f=>({commands:g})=>g.insertContent({type:this.name,attrs:f})}},addInputRules(){return[Ye({find:nt,type:this.type,getAttributes:f=>{const[,,g,L,v]=f;return{src:L,alt:g,title:v}}})]}}),rt=it;const ut={class:"pt-25 w-full z-10 shadow-md bg-header text-rice-500"},dt={class:"container mx-auto flex items-center p-4"},gt={class:"w-1/3"},vt={class:"text"},ct={class:"max-w-4xl mx-auto p-4 pt-10 text-[1.2rem]"},_t={key:0,class:"animate-fade-in-up flex flex-col gap-8"},mt={class:"relative z-10 text-white"},pt={class:"text-4xl font-bold mb-4"},bt={class:"mb-2 text-lg"},ft={class:"flex flex-wrap gap-2 mt-2"},xt={class:"flex flex-col gap-4 items-start"},ht={class:"self-end flex gap-2"},yt=["innerHTML"],kt={key:1,class:"w-full"},wt={key:0,class:"border p-2 flex gap-2 rounded-t-md"},Ct={class:"flex items-center gap-4 mb-4"},St={key:0,class:"text-red-500"},Lt={key:1},Tt={class:"text-gray-600"},Bt={class:"my-20"},Mt={class:"flex flex-col gap-4 mb-6 text-black"},Et={class:"font-bold"},Ut={class:"text-gray-800"},$t={key:1},Dt={key:0,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 text-black"},It={class:"bg-white p-6 rounded-md max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto"},Ht={class:"mb-4"},At={class:"relative flex flex-wrap items-center"},Rt={key:0,class:"absolute right-2 text-red-500"},Ot={key:0,class:"text-red-500 text-sm mt-1"},Pt={class:"mb-4"},zt={class:"mb-4"},Ft=["value"],Nt={class:"mb-4"},Vt={class:"relative"},jt=["innerHTML"],Gt=["onClick"],Wt=["placeholder"],qt={key:0,class:"absolute right-2 text-red-500"},Jt=["onClick","innerHTML"],Kt={key:0,class:"px-3 py-2 text-gray-500"},Qt={key:1,class:"text-red-500 text-sm mt-1"},Xt={class:"mb-4"},Yt={__name:"StoryDetail",props:{id:String},setup(f){const g=f,L=Je("handleAppScroll"),{user:v,isTeacher:$}=Ne(),{formatDate:j}=Qe(),i=d(null),k=d(null),w=d(!1),x=d({}),O=d({}),h=d(!1),G=H(()=>{if(!i.value)return{};const s=i.value.cover_image_url||"Background_2.png";try{let e=null;return i.value.cover_image_url.startsWith("http")?e=i.value.cover_image_url:e=new URL(Object.assign({"../assets/images/Background_1.png":ze,"../assets/images/Background_1_B.png":Pe,"../assets/images/Background_1_F.png":Oe,"../assets/images/Background_2.png":Re,"../assets/images/Background_Example.png":Ae,"../assets/images/Bar_Selected.png":He,"../assets/images/Bar_Unselected.png":Ie,"../assets/images/LoadingTrain.png":De,"../assets/images/Logo.gif":$e,"../assets/images/MainPage_Background.png":Ue,"../assets/images/MainPage_Background.webp":Ee,"../assets/images/MainPage_Background_T.png":Me,"../assets/images/MainPage_Example.png":Be,"../assets/images/MainPage_Pic.png":Te,"../assets/images/MainPage_Pic.webp":Le,"../assets/images/Title.png":Se,"../assets/images/Train_Long.png":Ce,"../assets/images/Train_Long_Full.png":we,"../assets/images/Train_Smoke.gif":ke,"../assets/images/Train_Smoke_W.gif":ye,"../assets/images/figure1.png":he,"../assets/images/figure2.png":xe,"../assets/images/figure3.png":fe,"../assets/images/figure4.png":be,"../assets/images/figure5.png":pe,"../assets/images/lightBulb.png":me,"../assets/images/lightBulb2.png":_e,"../assets/images/logo.png":ce,"../assets/images/logo_BW.png":ve,"../assets/images/story_bg.png":ge,"../assets/images/student.png":de,"../assets/images/平和國小_mobile_Example.png":ue})[`../assets/images/${s}`],import.meta.url).href,{backgroundImage:`url(${e})`}}catch{return{backgroundImage:`url(${new URL("/Pinghe/assets/Background_2-C9DmGNh3.png",import.meta.url).href})`}}}),n=et({content:"",extensions:[tt,st,lt.configure({nested:!0}),rt,at]});Ve(async()=>{try{if(v.value){i.value=await p.getShowcase(v.value.institution_id,g.id),console.log(i.value);let s=await p.getShowcaseComments(v.value.institution_id,g.id);k.value=s.items,console.log(k.value),x.value=await p.getShowcaseReactions(v.value.institution_id,g.id),O.value=await p.getShowcaseReactionUsers(v.value.institution_id,g.id,"👍"),console.log(x.value),console.log(O.value),console.log(x.value.user_reacted),w.value=x.value.user_reactions.length>0}}catch(s){console.error("Failed to fetch posts:",s)}}),je(()=>{n.value&&n.value.destroy()});const W=()=>{n.value&&n.value.commands.setContent(i.value.content||""),h.value=!0},q=async()=>{n.value&&(i.value.content=n.value.getHTML()),h.value=!1,console.log("內容已儲存:",n.value.getJSON()),alert("內容已儲存！")},J=()=>{n.value&&n.value.commands.setContent(i.value.content||""),h.value=!1},K=()=>{navigator.share?navigator.share({title:i.value.title,text:i.value.intro,url:window.location.href}).catch(console.error):(navigator.clipboard.writeText(window.location.href),alert("連結已複製到剪貼簿！"))},Q={id:v.value.id},C=d(""),X=async()=>{if(C.value.trim()==="")return;let s={title:"",content:C.value,post_type:"comment",status:"published"};console.log(s);let e=await p.createShowcaseComment(v.value.institution_id,g.id,s);console.log(e),C.value=""},Y=async()=>{i.value&&(w.value?await p.deleteShowcaseLike(v.value.institution_id,g.id):await p.addShowcaseLike(v.value.institution_id,g.id),x.value=await p.getShowcaseReactions(v.value.institution_id,g.id),w.value=!w.value)},D=d(!1),r=d({...i.value}),S=d(""),T=d(!1),P=d(null),I=V.filter(s=>s.value!==0),z=H(()=>I.filter(s=>r.value.sdgs_goals.includes(s.value))),F=H(()=>S.value?I.filter(s=>s.title.toLowerCase().includes(S.value.toLowerCase())&&!r.value.sdgs_goals.includes(s.value)):I.filter(s=>!r.value.sdgs_goals.includes(s.value)));Ge(P,()=>{T.value=!1});const m=d({title:!1,tags:!1}),Z=()=>{D.value=!1},ee=()=>{let s=!1;r.value.title.trim()||(m.value.title=!0,s=!0),r.value.sdgs_goals.length===0&&(m.value.tags=!0,s=!0),!s&&(i.value.title=r.value.title,i.value.intro=r.value.intro,i.value.time=r.value.time,i.value.types=r.value.sdgs_goals,i.value.cover_image_url=r.value.cover_image_url,D.value=!1)},te=s=>{const e=s.target.files[0];e&&(r.value.cover_image_url=e.name)},se=s=>{const e=new Date(s.target.value);r.value.time=Math.floor(e.getTime()/1e3)},le=s=>{r.value.sdgs_goals.includes(s.value)||r.value.sdgs_goals.push(s.value),S.value="",T.value=!1},ae=s=>{const e=r.value.sdgs_goals.indexOf(s);e!==-1&&r.value.sdgs_goals.splice(e,1)},oe=()=>{},ne=s=>{const e=s.target.files[0];if(e&&n.value){const y=URL.createObjectURL(e);n.value.chain().focus().setImage({src:y}).run()}s.target.value=""},ie=s=>{const e=s.target.files[0];if(e&&n.value){const y=URL.createObjectURL(e);n.value.chain().focus().extendMarkRange("link").setLink({href:y}).insertContent(e.name).run()}s.target.value=""};return(s,e)=>{const y=We("router-link");return o(),a("div",{class:"page-background content-scroller",onScroll:e[12]||(e[12]=(...l)=>u(L)&&u(L)(...l))},[t("header",ut,[t("div",dt,[t("div",gt,[A(y,{to:"/story",class:"back-home-btn"},{default:R(()=>[t("span",vt,[A(Ke,{align:"center"},{zh:R(()=>[...e[13]||(e[13]=[N("回上頁",-1)])]),en:R(()=>[...e[14]||(e[14]=[N("Return",-1)])]),_:1})]),e[15]||(e[15]=t("span",{class:"icon"},"←",-1))]),_:1})]),e[16]||(e[16]=t("div",{class:"w-1/3 text-center"},null,-1)),e[17]||(e[17]=t("div",{class:"w-1/3"},null,-1))])]),t("main",ct,[i.value?(o(),a("section",_t,[t("div",{style:qe(G.value),class:"relative bg-cover bg-center bg-opacity-70 p-7 rounded-md md:h-80 grid grid-cols-1 content-end overflow-hidden"},[e[18]||(e[18]=t("div",{class:"absolute inset-0 bg-black/40"},null,-1)),t("div",mt,[t("h1",pt,_(i.value.title),1),t("p",bt,_(i.value.intro),1),t("small",null,_(u(j)(i.value.time*1e3)),1),t("div",ft,[(o(!0),a(B,null,M(i.value.types,l=>(o(),a("span",{key:l,class:"px-3 py-1 text-sm rounded-full bg-blue-100 text-blue-800"},_(u(V)[l].title.replace(/<br\s*\/?>/gi,"")),1))),128))])])],4),t("section",xt,[t("div",ht,[!h.value&&u($)?(o(),a("button",{key:0,onClick:W,class:"bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600"}," 編輯內容 ")):c("",!0),h.value&&u($)?(o(),a("button",{key:1,onClick:q,class:"bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600"}," 儲存 ")):c("",!0),h.value&&u($)?(o(),a("button",{key:2,onClick:J,class:"bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600"}," 取消 ")):c("",!0),t("button",{onClick:K,class:"bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600"}," 分享 ")]),h.value?(o(),a("div",kt,[u(n)?(o(),a("div",wt,[t("button",{onClick:e[0]||(e[0]=l=>u(n).chain().focus().toggleHeading({level:1}).run()),class:b([{"is-active":u(n).isActive("heading",{level:1})},"p-2 rounded hover:bg-blue-200"]),title:"標題 1"}," H1 ",2),t("button",{onClick:e[1]||(e[1]=l=>u(n).chain().focus().toggleHeading({level:2}).run()),class:b([{"is-active":u(n).isActive("heading",{level:2})},"p-2 rounded hover:bg-blue-200"]),title:"標題 2"}," H2 ",2),t("button",{onClick:e[2]||(e[2]=l=>u(n).chain().focus().toggleHeading({level:3}).run()),class:b([{"is-active":u(n).isActive("heading",{level:3})},"p-2 rounded hover:bg-blue-200"]),title:"標題 3"}," H3 ",2),t("button",{onClick:e[3]||(e[3]=l=>u(n).chain().focus().toggleTaskList().run()),class:b([{"bg-blue-200":u(n).isActive("taskList")},"p-2 rounded hover:bg-blue-200"]),title:"待辦清單"},[...e[19]||(e[19]=[t("i",{class:"fa-solid fa-list-check"},null,-1)])],2),t("button",{onClick:e[4]||(e[4]=l=>u(n).chain().focus().toggleBulletList().run()),class:b([{"bg-blue-200":u(n).isActive("bulletList")},"p-2 rounded hover:bg-blue-200"]),title:"項目符號清單"},[...e[20]||(e[20]=[t("i",{class:"fa-solid fa-list-ul"},null,-1)])],2),t("button",{onClick:e[5]||(e[5]=l=>s.$refs.imageInput.click()),class:"p-2 rounded hover:bg-blue-200",title:"插入圖片"},[...e[21]||(e[21]=[t("i",{class:"fa-solid fa-image"},null,-1)])]),t("button",{onClick:e[6]||(e[6]=l=>s.$refs.fileInput.click()),class:"p-2 rounded hover:bg-blue-200",title:"插入檔案"},[...e[22]||(e[22]=[t("i",{class:"fa-solid fa-paperclip"},null,-1)])]),t("input",{ref:"imageInput",type:"file",accept:"image/*",onChange:ne,style:{display:"none"}},null,544),t("input",{ref:"fileInput",type:"file",onChange:ie,style:{display:"none"}},null,544)])):c("",!0),A(u(ot),{editor:u(n),class:"w-full prose max-w-none border-x border-b p-4 rounded-b-md overflow-hidden"},null,8,["editor"])])):(o(),a("div",{key:0,class:"prose max-w-none",innerHTML:i.value.content},null,8,yt))]),t("div",Ct,[t("button",{onClick:Y,class:"flex items-center gap-2"},[w.value?(o(),a("span",St,_(x.value.user_reactions[0]),1)):(o(),a("span",Lt,"按讚")),t("span",null,_(x.value.total_reactions),1)]),t("span",Tt,"留言數: "+_(k.value?k.value.length:0),1)]),t("section",Bt,[e[23]||(e[23]=t("h2",{class:"text-xl mb-4"},"留言板",-1)),t("div",Mt,[(o(!0),a(B,null,M(k.value,l=>(o(),a("div",{key:l.uuid,class:b(["p-4 rounded-md",l.author_id===Q.id?"bg-green-100":"bg-gray-100"])},[t("p",Et,_(l.author_name),1),t("p",Ut,_(l.content),1)],2))),128))]),t("div",null,[E(t("textarea",{"onUpdate:modelValue":e[7]||(e[7]=l=>C.value=l),class:"w-full p-2 border rounded-md",rows:"3",placeholder:"在這裡寫下你的留言..."},null,512),[[U,C.value]]),t("button",{onClick:X,class:"mt-2 bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600"}," 發布留言 ")])])])):(o(),a("div",$t,[...e[24]||(e[24]=[t("p",null,"找不到這篇故事。",-1)])]))]),D.value?(o(),a("div",Dt,[t("div",It,[e[33]||(e[33]=t("h2",{class:"text-xl mb-4"},"編輯故事",-1)),t("div",Ht,[e[26]||(e[26]=t("label",{class:"block text-lg font-medium mb-2"},"標題*",-1)),t("div",At,[E(t("input",{type:"text","onUpdate:modelValue":e[8]||(e[8]=l=>r.value.title=l),class:b(["w-full p-2 border border-gray-300 rounded-md",{"border-red-500":m.value.title}])},null,2),[[U,r.value.title]]),m.value.title?(o(),a("div",Rt,[...e[25]||(e[25]=[t("i",{class:"fa-solid fa-circle-exclamation"},null,-1)])])):c("",!0)]),m.value.title?(o(),a("p",Ot," 請輸入標題 ")):c("",!0)]),t("div",Pt,[e[27]||(e[27]=t("label",{class:"block text-lg font-medium mb-2"},"介紹",-1)),E(t("input",{type:"text","onUpdate:modelValue":e[9]||(e[9]=l=>r.value.intro=l),class:"w-full p-2 border border-gray-300 rounded-md"},null,512),[[U,r.value.intro]])]),t("div",zt,[e[28]||(e[28]=t("label",{class:"block text-lg font-medium mb-2"},"時間",-1)),t("input",{type:"date",value:r.value.time?new Date(r.value.time*1e3).toISOString().split("T")[0]:"",onInput:se,class:"w-full p-2 border border-gray-300 rounded-md"},null,40,Ft)]),t("div",Nt,[e[30]||(e[30]=t("label",{class:"block text-lg font-medium mb-2"},"SDGs標籤*",-1)),t("div",Vt,[t("div",{class:b(["relative flex flex-wrap items-center gap-1 p-2 border border-gray-300 rounded-md min-h-[2.5rem]",{"border-red-500":m.value.tags}])},[(o(!0),a(B,null,M(z.value,l=>(o(),a("span",{key:l.value,class:"inline-flex items-center px-2 py-1 text-sm bg-blue-500 text-white rounded-full"},[t("span",{innerHTML:l.title},null,8,jt),t("button",{onClick:re=>ae(l.value),class:"ml-1 text-white hover:text-gray-200"}," × ",8,Gt)]))),128)),E(t("input",{type:"text","onUpdate:modelValue":e[10]||(e[10]=l=>S.value=l),onFocus:e[11]||(e[11]=l=>T.value=!0),onInput:oe,class:"flex-1 min-w-0 outline-none bg-transparent",placeholder:z.value.length===0?"搜尋SDGs標籤...":""},null,40,Wt),[[U,S.value]]),m.value.tags?(o(),a("div",qt,[...e[29]||(e[29]=[t("i",{class:"fa-solid fa-circle-exclamation"},null,-1)])])):c("",!0)],2),T.value?(o(),a("div",{key:0,ref_key:"editDropdown",ref:P,class:"absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto mt-1"},[(o(!0),a(B,null,M(F.value,l=>(o(),a("div",{key:l.value,onClick:re=>le(l),class:"px-3 py-2 hover:bg-orange-300 cursor-pointer",innerHTML:l.title},null,8,Jt))),128)),F.value.length===0?(o(),a("div",Kt," 無匹配的標籤 ")):c("",!0)],512)):c("",!0),m.value.tags?(o(),a("p",Qt," 請至少選擇一個SDGs標籤 ")):c("",!0)])]),t("div",Xt,[e[31]||(e[31]=t("label",{class:"block text-lg font-medium mb-2"},"背景圖片",-1)),t("input",{type:"file",onChange:te,accept:"image/*",class:"w-full p-2 border border-gray-300 rounded-md"},null,32),e[32]||(e[32]=t("p",{class:"text-sm text-gray-500 mt-1"}," 選擇新圖片上傳，將替換現有背景圖片。 ",-1))]),t("div",{class:"flex justify-end gap-2"},[t("button",{onClick:Z,class:"px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600"}," 取消 "),t("button",{onClick:ee,class:"px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600"}," 儲存 ")])])])):c("",!0)],32)}}},os=Fe(Yt,[["__scopeId","data-v-802f0a1b"]]);export{os as default};
