import{B as j,u as q,r as g,c as w,C as J,D as K,a as r,o as n,b as t,f as y,g as k,h as $,i as R,e as f,d as u,v as p,n as d,F as L,p as V,q as m,l as W,j as Y,t as M}from"./index-OjV9Cy1S.js";import{C as P}from"./CJKSub-D4Q5-j6v.js";import{u as Q,i as X,a as Z,b as ee,E as te}from"./index-BL31sUer.js";import{u as se}from"./useDateTime-C5bsu7z3.js";import{s as le}from"./SDGs_goal-BU-5yG0n.js";const ae={class:"page-background content-scroller"},oe={class:"pt-25 w-full z-10 shadow-md bg-header text-rice-500"},re={class:"container mx-auto flex items-center p-4"},ne={class:"w-1/3"},ie={class:"text"},ue={class:"max-w-4xl mx-auto p-4 pt-10 text-[1.2rem]"},de={class:"flex flex-col gap-4"},me={key:0,class:"text-red-500 text-sm mt-1"},ve={class:"mt-2 relative"},ce={class:"relative"},ge=["onClick"],fe=["placeholder"],pe=["onClick"],be={key:0,class:"px-3 py-2 text-gray-500"},_e={key:0,class:"text-red-500 text-sm mt-1"},xe={key:0,class:"text-red-500 text-sm mt-1"},we={class:"mt-1 flex gap-2 items-center"},ye={key:0,class:"text-red-500 text-sm mt-1"},ke={key:1,class:"text-red-500 text-sm mt-1"},he={__name:"StoryNew",setup(De){const{user:h}=q(),E=Y(),{formatISO:D}=se(),s=g({title:"",content:"",intro:"",start_time:null,end_time:null,duration_value:1,duration_unit:"day",sdgs_goals:[],author_id:h.value.id,post_type:"general"}),_=le.filter(a=>a.value!==0).map(a=>({...a,title:a.title.replace(/<br\s*\/?>/g,"")})),v=g(""),b=g(!1),S=g(null),C=w(()=>v.value?_.filter(a=>a.title.toLowerCase().includes(v.value.toLowerCase())&&!s.value.sdgs_goals.includes(a.value)):_.filter(a=>!s.value.sdgs_goals.includes(a.value))),T=w(()=>_.filter(a=>s.value.sdgs_goals.includes(a.value)));w(()=>{if(!s.value.start_time||!s.value.duration_value)return"";const a=new Date(s.value.start_time),e=new Date(a);switch(s.value.duration_unit){case"day":e.setDate(e.getDate()+parseInt(s.value.duration_value));break;case"week":e.setDate(e.getDate()+parseInt(s.value.duration_value)*7);break;case"month":e.setMonth(e.getMonth()+parseInt(s.value.duration_value));break}return e.toLocaleString("zh-TW",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})});const I=a=>{s.value.sdgs_goals.includes(a.value)||s.value.sdgs_goals.push(a.value),v.value="",b.value=!1},N=a=>{const e=s.value.sdgs_goals.indexOf(a);e!==-1&&s.value.sdgs_goals.splice(e,1)},U=()=>{},z=(a,e)=>{if(!s.value.start_time){alert("請先選擇開始時間");return}const c=new Date(s.value.start_time),l=new Date(c);switch(e){case"day":l.setDate(l.getDate()+a);break;case"week":l.setDate(l.getDate()+a*7);break;case"month":l.setMonth(l.getMonth()+a);break}const x=l.getFullYear(),O=String(l.getMonth()+1).padStart(2,"0"),A=String(l.getDate()).padStart(2,"0"),G=String(l.getHours()).padStart(2,"0"),H=String(l.getMinutes()).padStart(2,"0");s.value.end_time=`${x}-${O}-${A}T${G}:${H}`},B=()=>{if(!s.value.start_time){alert("請先選擇開始時間");return}z(1,"day")},o=g({title:!1,tags:!1,content:!1,start_time:!1,end_time:!1}),i=Q({content:"<p>開始寫下你的故事...</p>",extensions:[X,Z,ee.configure({nested:!0})]});J(S,()=>{b.value=!1}),K(()=>{i.value&&i.value.destroy()});const F=()=>{o.value={title:!1,tags:!1,content:!1,start_time:!1,end_time:!1},i.value&&(s.value.content=i.value.getHTML());let a=!1;if(s.value.title.trim()||(o.value.title=!0,a=!0),s.value.sdgs_goals.length===0&&(o.value.tags=!0,a=!0),i.value.isEmpty&&(o.value.content=!0,a=!0),s.value.start_time||(o.value.start_time=!0,a=!0),s.value.end_time&&s.value.start_time){const c=new Date(s.value.start_time);new Date(s.value.end_time)<=c&&(o.value.end_time=!0,a=!0)}if(a)return;const e={...s.value};e.sdgs_goals=[...s.value.sdgs_goals],e.start_time&&(e.start_time=D(new Date(e.start_time).getTime()/1e3)),e.end_time&&(e.end_time=D(new Date(e.end_time).getTime()/1e3)),console.log("New Story Data:",e),W.createShowcase(h.value.institution_id,e),E.push("/story")};return(a,e)=>{const c=R("router-link");return n(),r("div",ae,[t("header",oe,[t("div",re,[t("div",ne,[y(c,{to:"/story",class:"back-home-btn"},{default:k(()=>[t("span",ie,[y(P,{align:"left"},{zh:k(()=>[...e[8]||(e[8]=[$("取消",-1)])]),en:k(()=>[...e[9]||(e[9]=[$("Cancel",-1)])]),_:1})]),e[10]||(e[10]=t("span",{class:"icon"},"←",-1))]),_:1})]),e[11]||(e[11]=t("div",{class:"w-1/3 text-center"},[t("h1",{class:"text-2xl md:text-3xl font-bold"},"建立故事")],-1)),e[12]||(e[12]=t("div",{class:"w-1/3"},null,-1))])]),t("main",ue,[t("div",de,[t("div",null,[e[13]||(e[13]=t("label",{for:"title",class:"block text-lg font-medium"},"標題*",-1)),f(t("input",{type:"text","onUpdate:modelValue":e[0]||(e[0]=l=>s.value.title=l),id:"title",class:d(["mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500",{"border-red-500":o.value.title}])},null,2),[[p,s.value.title]]),o.value.title?(n(),r("p",me," 請輸入標題 ")):u("",!0)]),t("div",null,[e[14]||(e[14]=t("label",{class:"block text-lg font-medium"},"SDGs標籤*",-1)),t("div",ve,[t("div",ce,[t("div",{class:d(["flex flex-wrap items-center gap-1 p-2 border border-gray-300 rounded-md shadow-sm focus-within:ring-indigo-500 focus-within:border-indigo-500 min-h-[2.5rem]",{"border-red-500":o.value.tags}])},[(n(!0),r(L,null,V(T.value,l=>(n(),r("span",{key:l.value,class:"inline-flex items-center px-2 py-1 text-sm bg-blue-500 text-white rounded-full"},[t("span",null,M(l.title),1),t("button",{onClick:x=>N(l.value),class:"ml-1 text-white hover:text-gray-200"}," × ",8,ge)]))),128)),f(t("input",{type:"text","onUpdate:modelValue":e[1]||(e[1]=l=>v.value=l),onFocus:e[2]||(e[2]=l=>b.value=!0),onInput:U,class:"flex-1 min-w-0 outline-none bg-transparent",placeholder:T.value.length===0?"搜尋SDGs標籤...":"",ref:"searchInput"},null,40,fe),[[p,v.value]])],2),b.value?(n(),r("div",{key:0,ref_key:"dropdown",ref:S,class:"absolute z-10 w-full bg-pblue-200 border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto mt-1"},[(n(!0),r(L,null,V(C.value,l=>(n(),r("div",{key:l.value,onClick:x=>I(l),class:"px-3 py-2 hover:bg-orange-300 cursor-pointer"},M(l.title),9,pe))),128)),C.value.length===0?(n(),r("div",be," 無匹配的標籤 ")):u("",!0)],512)):u("",!0)]),o.value.tags?(n(),r("p",_e," 請至少選擇一個SDGs標籤 ")):u("",!0)])]),t("div",null,[e[15]||(e[15]=t("label",{for:"intro",class:"block text-lg font-medium"},"簡介",-1)),f(t("input",{type:"text","onUpdate:modelValue":e[3]||(e[3]=l=>s.value.intro=l),id:"intro",class:"mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"},null,512),[[p,s.value.intro]])]),t("div",null,[e[16]||(e[16]=t("label",{for:"start_time",class:"block text-lg font-medium"},"時間*",-1)),f(t("input",{type:"datetime-local","onUpdate:modelValue":e[4]||(e[4]=l=>s.value.start_time=l),id:"start_time",class:d(["mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500",{"border-red-500":o.value.start_time}])},null,2),[[p,s.value.start_time]]),o.value.start_time?(n(),r("p",xe," 請選擇開始時間 ")):u("",!0)]),t("div",null,[t("div",we,[t("button",{onClick:B,class:"bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600"}," 加入結束時間 "),f(t("input",{type:"datetime-local","onUpdate:modelValue":e[5]||(e[5]=l=>s.value.end_time=l),id:"end_time",class:d(["flex-1 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500",{"border-red-500":o.value.end_time}]),readonly:""},null,2),[[p,s.value.end_time]])]),o.value.end_time?(n(),r("p",ye," 請新增有效的結束時間 ")):u("",!0)]),t("div",null,[e[19]||(e[19]=t("label",{class:"block text-lg font-medium"},"內容*",-1)),m(i)?(n(),r("div",{key:0,class:d(["border p-2 flex gap-2 rounded-t-md mt-1",{"border-red-500":o.value.content}])},[t("button",{onClick:e[6]||(e[6]=l=>m(i).chain().focus().toggleTaskList().run()),class:d([{"bg-blue-200":m(i).isActive("taskList")},"p-2 rounded hover:bg-blue-200"]),title:"待辦清單"},[...e[17]||(e[17]=[t("i",{class:"fa-solid fa-list-check"},null,-1)])],2),t("button",{onClick:e[7]||(e[7]=l=>m(i).chain().focus().toggleBulletList().run()),class:d([{"bg-blue-200":m(i).isActive("bulletList")},"p-2 rounded hover:bg-blue-200"]),title:"項目符號清單"},[...e[18]||(e[18]=[t("i",{class:"fa-solid fa-list-ul"},null,-1)])],2)],2)):u("",!0),y(m(te),{editor:m(i),class:d(["w-full prose max-w-none border-x border-b p-4 rounded-b-md bg-white text-black",{"border-red-500":o.value.content}])},null,8,["editor","class"]),o.value.content?(n(),r("p",ke," 請輸入內容 ")):u("",!0)]),t("div",{class:"self-end"},[t("button",{onClick:F,class:"bg-green-500 text-white px-6 py-2 rounded-md hover:bg-green-600"}," 儲存 ")])])])])}}},Ve=j(he,[["__scopeId","data-v-fe86a628"]]);export{Ve as default};
