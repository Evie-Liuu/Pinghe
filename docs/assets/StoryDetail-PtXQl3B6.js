import{_ as fe,a as be,b as he,c as xe,d as ye,e as ke,f as we,g as Ce,h as Se,i as Le,j as Ue,k as Te,l as Ee,m as Ie,n as Be,o as Me,p as $e,q as Re,r as De,s as He,t as Ae,u as Fe,v as Oe,w as Ne,x as je,y as ze,z as Pe,A as Ve,B as Ge,C as We,D as Je,E as qe}from"./å¹³å’Œåœ‹å°_mobile_Example-xpo9UaZU.js";import{C as Ke,u as Qe,r as g,c as N,z as Xe,l as _,E as Ye,D as Ze,a as n,o as i,b as t,d as m,f as j,g as z,h as K,i as et,s as tt,t as p,q as d,F as B,p as M,n as b,e as $,v as R,B as st}from"./index-BdfhtmlJ.js";import{s as Q}from"./SDGs_goal-BU-5yG0n.js";import{C as lt}from"./CJKSub-BfqnPf4a.js";import{u as at}from"./useDateFormat-Tij9gOpP.js";import{N as ot,n as nt,m as it,u as rt,i as ut,a as dt,b as gt,c as ct,E as vt}from"./index-Dzb-g-gX.js";var _t=/(?:^|\s)(!\[(.+|:?)]\((\S+)(?:(?:\s+)["'](\S+)["'])?\))$/,mt=ot.create({name:"image",addOptions(){return{inline:!1,allowBase64:!1,HTMLAttributes:{}}},inline(){return this.options.inline},group(){return this.options.inline?"inline":"block"},draggable:!0,addAttributes(){return{src:{default:null},alt:{default:null},title:{default:null},width:{default:null},height:{default:null}}},parseHTML(){return[{tag:this.options.allowBase64?"img[src]":'img[src]:not([src^="data:"])'}]},renderHTML({HTMLAttributes:h}){return["img",it(this.options.HTMLAttributes,h)]},addCommands(){return{setImage:h=>({commands:c})=>c.insertContent({type:this.name,attrs:h})}},addInputRules(){return[nt({find:_t,type:this.type,getAttributes:h=>{const[,,c,T,v]=h;return{src:T,alt:c,title:v}}})]}}),pt=mt;const ft={class:"pt-25 w-full z-10 shadow-md bg-header text-rice-500"},bt={class:"container mx-auto flex items-center p-4"},ht={class:"w-1/3"},xt={class:"text"},yt={class:"max-w-4xl mx-auto p-4 pt-10 text-[1.2rem]"},kt={key:0,class:"animate-fade-in-up flex flex-col gap-8"},wt={class:"relative z-10 text-white"},Ct={class:"text-4xl font-bold mb-4"},St={class:"mb-2 text-lg"},Lt={class:"flex flex-wrap gap-2 mt-2"},Ut={class:"flex flex-col gap-4 items-start"},Tt={class:"self-end flex gap-2"},Et=["innerHTML"],It={key:1,class:"w-full"},Bt={key:0,class:"border p-2 flex gap-2 rounded-t-md"},Mt={class:"flex items-center gap-4 mb-4"},$t={key:0,class:"text-red-500"},Rt={key:1},Dt={class:"text-gray-600"},Ht={class:"my-20"},At={class:"flex flex-col gap-4 mb-6 text-black"},Ft={class:"font-bold"},Ot={class:"text-gray-800"},Nt={key:1},jt={key:0,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 text-black"},zt={class:"bg-white p-6 rounded-md max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto"},Pt={class:"mb-4"},Vt={class:"relative flex flex-wrap items-center"},Gt={key:0,class:"absolute right-2 text-red-500"},Wt={key:0,class:"text-red-500 text-sm mt-1"},Jt={class:"mb-4"},qt={class:"mb-4"},Kt=["value"],Qt={class:"mb-4"},Xt={class:"relative"},Yt=["innerHTML"],Zt=["onClick"],es=["placeholder"],ts={key:0,class:"absolute right-2 text-red-500"},ss=["onClick","innerHTML"],ls={key:0,class:"px-3 py-2 text-gray-500"},as={key:1,class:"text-red-500 text-sm mt-1"},os={class:"mb-4"},ns={__name:"StoryDetail",props:{id:String},setup(h){const c=h,T=st("handleAppScroll"),{user:v,isTeacher:D}=Qe(),{formatDate:X}=at(),o=g(null),w=g(null),C=g(!1),x=g({}),P=g({}),y=g(!1),V=g([]),Y=N(()=>{if(!o.value)return{};const s=o.value.cover_image_url||"Background_2.png";try{let e=null;return o.value.cover_image_url.startsWith("http")?e=o.value.cover_image_url:e=new URL(Object.assign({"../assets/images/Background_1.png":qe,"../assets/images/Background_1_B.png":Je,"../assets/images/Background_1_F.png":We,"../assets/images/Background_2.png":Ge,"../assets/images/Background_Example.png":Ve,"../assets/images/Bar_Selected.png":Pe,"../assets/images/Bar_Unselected.png":ze,"../assets/images/LoadingTrain.png":je,"../assets/images/Logo.gif":Ne,"../assets/images/MainPage_Background.png":Oe,"../assets/images/MainPage_Background.webp":Fe,"../assets/images/MainPage_Background_T.png":Ae,"../assets/images/MainPage_Example.png":He,"../assets/images/MainPage_Pic.png":De,"../assets/images/MainPage_Pic.webp":Re,"../assets/images/Title.png":$e,"../assets/images/Train_Long.png":Me,"../assets/images/Train_Long_Full.png":Be,"../assets/images/Train_Smoke.gif":Ie,"../assets/images/Train_Smoke_W.gif":Ee,"../assets/images/figure1.png":Te,"../assets/images/figure2.png":Ue,"../assets/images/figure3.png":Le,"../assets/images/figure4.png":Se,"../assets/images/figure5.png":Ce,"../assets/images/lightBulb.png":we,"../assets/images/lightBulb2.png":ke,"../assets/images/logo.png":ye,"../assets/images/logo_BW.png":xe,"../assets/images/story_bg.png":he,"../assets/images/student.png":be,"../assets/images/å¹³å’Œåœ‹å°_mobile_Example.png":fe})[`../assets/images/${s}`],import.meta.url).href,{backgroundImage:`url(${e})`}}catch{return{backgroundImage:`url(${new URL(""+new URL("Background_2-C9DmGNh3.png",import.meta.url).href,import.meta.url).href})`}}}),a=rt({content:"",extensions:[ut,dt,gt.configure({nested:!0}),pt,ct]});Xe(async()=>{try{if(v.value){o.value=await _.getShowcase(v.value.institution_id,c.id),console.log(o.value);let s=await _.getShowcaseComments(v.value.institution_id,c.id);w.value=s.items,console.log(w.value),x.value=await _.getShowcaseReactions(v.value.institution_id,c.id),P.value=await _.getShowcaseReactionUsers(v.value.institution_id,c.id,"ğŸ‘"),console.log(x.value),console.log(P.value),console.log(x.value.user_reacted),C.value=x.value.user_reactions.length>0}}catch(s){console.error("Failed to fetch posts:",s)}}),Ye(()=>{a.value&&a.value.destroy()});const Z=()=>{a.value&&a.value.commands.setContent(o.value.content||""),V.value=[...o.value.media_files||[]],U.value=[],y.value=!0},ee=async()=>{if(a.value){o.value.content=a.value.getHTML();const s=me(a.value.getJSON()).filter(u=>!u.startsWith("blob:"));o.value.media_files=s;const e=V.value.filter(u=>!s.includes(u));if(e.length>0)try{await _.deleteImage(e),console.log("å·²åˆªé™¤çš„åœ–ç‰‡:",e)}catch(u){console.error("åˆªé™¤åœ–ç‰‡å¤±æ•—:",u)}}console.log("å…§å®¹å·²å„²å­˜:",a.value.getJSON());try{let s=await _.updateShowcase(v.value.institution_id,o.value.post_id,o.value);console.log(s)}catch(s){console.error("Failed to fetch:",s)}y.value=!1,alert("å…§å®¹å·²å„²å­˜ï¼")},te=async()=>{if(a.value&&(a.value.commands.setContent(o.value.content||""),U.value.length>0))try{await _.deleteImage(U.value)}catch(s){console.error("Failed to fetch:",s)}y.value=!1},se=()=>{navigator.share?navigator.share({title:o.value.title,text:o.value.intro,url:window.location.href}).catch(console.error):(navigator.clipboard.writeText(window.location.href),alert("é€£çµå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼"))},le={id:v.value.id},S=g(""),ae=async()=>{if(S.value.trim()==="")return;let s={title:"",content:S.value,post_type:"comment",status:"published"};console.log(s);let e=await _.createShowcaseComment(v.value.institution_id,c.id,s);console.log(e),S.value=""},oe=async()=>{o.value&&(C.value?await _.deleteShowcaseLike(v.value.institution_id,c.id):await _.addShowcaseLike(v.value.institution_id,c.id),x.value=await _.getShowcaseReactions(v.value.institution_id,c.id),C.value=!C.value)},H=g(!1),r=g({...o.value}),L=g(""),E=g(!1),G=g(null),A=Q.filter(s=>s.value!==0),W=N(()=>A.filter(s=>r.value.sdgs_goals.includes(s.value))),J=N(()=>L.value?A.filter(s=>s.title.toLowerCase().includes(L.value.toLowerCase())&&!r.value.sdgs_goals.includes(s.value)):A.filter(s=>!r.value.sdgs_goals.includes(s.value)));Ze(G,()=>{E.value=!1});const f=g({title:!1,tags:!1}),ne=()=>{H.value=!1},ie=()=>{let s=!1;r.value.title.trim()||(f.value.title=!0,s=!0),r.value.sdgs_goals.length===0&&(f.value.tags=!0,s=!0),!s&&(o.value.title=r.value.title,o.value.intro=r.value.intro,o.value.time=r.value.time,o.value.types=r.value.sdgs_goals,o.value.cover_image_url=r.value.cover_image_url,H.value=!1)},re=s=>{const e=s.target.files[0];e&&(r.value.cover_image_url=e.name)},ue=s=>{const e=new Date(s.target.value);r.value.time=Math.floor(e.getTime()/1e3)},de=s=>{r.value.sdgs_goals.includes(s.value)||r.value.sdgs_goals.push(s.value),L.value="",E.value=!1},ge=s=>{const e=r.value.sdgs_goals.indexOf(s);e!==-1&&r.value.sdgs_goals.splice(e,1)},ce=()=>{},U=g([]),ve=async s=>{const e=s.target.files[0];if(!(!e||!a.value)){try{const u=URL.createObjectURL(e);a.value.chain().focus().setImage({src:u,alt:"ä¸Šå‚³ä¸­..."}).run();const l=await _.uploadImage(e,`story/${c.id}`);if(l.uploaded_files&&l.uploaded_files.length>0){const k=l.uploaded_files[0].file_url;U.value.push(k),console.log(U.value);const{state:I}=a.value,{doc:F}=I;let O=null;F.descendants((q,pe)=>{if(q.type.name==="image"&&q.attrs.src===u)return O=pe,!1}),O!==null&&a.value.chain().focus().setNodeSelection(O).setImage({src:k,alt:e.name}).run(),URL.revokeObjectURL(u)}else throw new Error("ä¸Šå‚³å¤±æ•—ï¼šä¼ºæœå™¨å›æ‡‰æ ¼å¼éŒ¯èª¤")}catch(u){console.error("åœ–ç‰‡ä¸Šå‚³å¤±æ•—:",u),alert(`åœ–ç‰‡ä¸Šå‚³å¤±æ•—: ${u.message}`);const{state:l}=a.value,{doc:k}=l;k.descendants((I,F)=>{if(I.type==="image"&&I.attrs.src===loadingUrl)return a.value.chain().focus().setNodeSelection(F).deleteSelection().run(),!1}),URL.revokeObjectURL(loadingUrl)}s.target.value=""}},_e=s=>{const e=s.target.files[0];if(e&&a.value){const u=URL.createObjectURL(e);a.value.chain().focus().extendMarkRange("link").setLink({href:u}).insertContent(e.name).run()}s.target.value=""},me=s=>{const e=[],u=l=>{l.type==="image"&&l.attrs&&l.attrs.src&&e.push(l.attrs.src),l.content&&l.content.forEach(u)};return u(s),e};return(s,e)=>{const u=et("router-link");return i(),n("div",{class:"page-background content-scroller",onScroll:e[12]||(e[12]=(...l)=>d(T)&&d(T)(...l))},[t("header",ft,[t("div",bt,[t("div",ht,[j(u,{to:"/story",class:"back-home-btn"},{default:z(()=>[t("span",xt,[j(lt,{align:"center"},{zh:z(()=>[...e[13]||(e[13]=[K("å›ä¸Šé ",-1)])]),en:z(()=>[...e[14]||(e[14]=[K("Return",-1)])]),_:1})]),e[15]||(e[15]=t("span",{class:"icon"},"â†",-1))]),_:1})]),e[16]||(e[16]=t("div",{class:"w-1/3 text-center"},null,-1)),e[17]||(e[17]=t("div",{class:"w-1/3"},null,-1))])]),t("main",yt,[o.value?(i(),n("section",kt,[t("div",{style:tt(Y.value),class:"relative bg-cover bg-center bg-opacity-70 p-7 rounded-md md:h-80 grid grid-cols-1 content-end overflow-hidden"},[e[18]||(e[18]=t("div",{class:"absolute inset-0 bg-black/40"},null,-1)),t("div",wt,[t("h1",Ct,p(o.value.title),1),t("p",St,p(o.value.intro),1),t("small",null,p(d(X)(o.value.time*1e3)),1),t("div",Lt,[(i(!0),n(B,null,M(o.value.types,l=>(i(),n("span",{key:l,class:"px-3 py-1 text-sm rounded-full bg-blue-100 text-blue-800"},p(d(Q)[l].title.replace(/<br\s*\/?>/gi,"")),1))),128))])])],4),t("section",Ut,[t("div",Tt,[!y.value&&d(D)?(i(),n("button",{key:0,onClick:Z,class:"bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600"}," ç·¨è¼¯å…§å®¹ ")):m("",!0),y.value&&d(D)?(i(),n("button",{key:1,onClick:ee,class:"bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600"}," å„²å­˜ ")):m("",!0),y.value&&d(D)?(i(),n("button",{key:2,onClick:te,class:"bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600"}," å–æ¶ˆ ")):m("",!0),t("button",{onClick:se,class:"bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600"}," åˆ†äº« ")]),y.value?(i(),n("div",It,[d(a)?(i(),n("div",Bt,[t("button",{onClick:e[0]||(e[0]=l=>d(a).chain().focus().toggleHeading({level:1}).run()),class:b([{"is-active":d(a).isActive("heading",{level:1})},"p-2 rounded hover:bg-blue-200"]),title:"æ¨™é¡Œ 1"}," H1 ",2),t("button",{onClick:e[1]||(e[1]=l=>d(a).chain().focus().toggleHeading({level:2}).run()),class:b([{"is-active":d(a).isActive("heading",{level:2})},"p-2 rounded hover:bg-blue-200"]),title:"æ¨™é¡Œ 2"}," H2 ",2),t("button",{onClick:e[2]||(e[2]=l=>d(a).chain().focus().toggleHeading({level:3}).run()),class:b([{"is-active":d(a).isActive("heading",{level:3})},"p-2 rounded hover:bg-blue-200"]),title:"æ¨™é¡Œ 3"}," H3 ",2),t("button",{onClick:e[3]||(e[3]=l=>d(a).chain().focus().toggleTaskList().run()),class:b([{"bg-blue-200":d(a).isActive("taskList")},"p-2 rounded hover:bg-blue-200"]),title:"å¾…è¾¦æ¸…å–®"},[...e[19]||(e[19]=[t("i",{class:"fa-solid fa-list-check"},null,-1)])],2),t("button",{onClick:e[4]||(e[4]=l=>d(a).chain().focus().toggleBulletList().run()),class:b([{"bg-blue-200":d(a).isActive("bulletList")},"p-2 rounded hover:bg-blue-200"]),title:"é …ç›®ç¬¦è™Ÿæ¸…å–®"},[...e[20]||(e[20]=[t("i",{class:"fa-solid fa-list-ul"},null,-1)])],2),t("button",{onClick:e[5]||(e[5]=l=>s.$refs.imageInput.click()),class:"p-2 rounded hover:bg-blue-200",title:"æ’å…¥åœ–ç‰‡"},[...e[21]||(e[21]=[t("i",{class:"fa-solid fa-image"},null,-1)])]),t("button",{onClick:e[6]||(e[6]=l=>s.$refs.fileInput.click()),class:"p-2 rounded hover:bg-blue-200",title:"æ’å…¥æª”æ¡ˆ"},[...e[22]||(e[22]=[t("i",{class:"fa-solid fa-paperclip"},null,-1)])]),t("input",{ref:"imageInput",type:"file",accept:"image/*",onChange:ve,style:{display:"none"}},null,544),t("input",{ref:"fileInput",type:"file",onChange:_e,style:{display:"none"}},null,544)])):m("",!0),j(d(vt),{editor:d(a),class:"w-full prose max-w-none border-x border-b p-4 rounded-b-md overflow-hidden"},null,8,["editor"])])):(i(),n("div",{key:0,class:"prose max-w-none",innerHTML:o.value.content},null,8,Et))]),t("div",Mt,[t("button",{onClick:oe,class:"flex items-center gap-2"},[C.value?(i(),n("span",$t,p(x.value.user_reactions[0]),1)):(i(),n("span",Rt,"æŒ‰è®š")),t("span",null,p(x.value.total_reactions),1)]),t("span",Dt,"ç•™è¨€æ•¸: "+p(w.value?w.value.length:0),1)]),t("section",Ht,[e[23]||(e[23]=t("h2",{class:"text-xl mb-4"},"ç•™è¨€æ¿",-1)),t("div",At,[(i(!0),n(B,null,M(w.value,l=>(i(),n("div",{key:l.uuid,class:b(["p-4 rounded-md",l.author_id===le.id?"bg-green-100":"bg-gray-100"])},[t("p",Ft,p(l.author_name),1),t("p",Ot,p(l.content),1)],2))),128))]),t("div",null,[$(t("textarea",{"onUpdate:modelValue":e[7]||(e[7]=l=>S.value=l),class:"w-full p-2 border rounded-md",rows:"3",placeholder:"åœ¨é€™è£¡å¯«ä¸‹ä½ çš„ç•™è¨€..."},null,512),[[R,S.value]]),t("button",{onClick:ae,class:"mt-2 bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600"}," ç™¼å¸ƒç•™è¨€ ")])])])):(i(),n("div",Nt,[...e[24]||(e[24]=[t("p",null,"æ‰¾ä¸åˆ°é€™ç¯‡æ•…äº‹ã€‚",-1)])]))]),H.value?(i(),n("div",jt,[t("div",zt,[e[33]||(e[33]=t("h2",{class:"text-xl mb-4"},"ç·¨è¼¯æ•…äº‹",-1)),t("div",Pt,[e[26]||(e[26]=t("label",{class:"block text-lg font-medium mb-2"},"æ¨™é¡Œ*",-1)),t("div",Vt,[$(t("input",{type:"text","onUpdate:modelValue":e[8]||(e[8]=l=>r.value.title=l),class:b(["w-full p-2 border border-gray-300 rounded-md",{"border-red-500":f.value.title}])},null,2),[[R,r.value.title]]),f.value.title?(i(),n("div",Gt,[...e[25]||(e[25]=[t("i",{class:"fa-solid fa-circle-exclamation"},null,-1)])])):m("",!0)]),f.value.title?(i(),n("p",Wt," è«‹è¼¸å…¥æ¨™é¡Œ ")):m("",!0)]),t("div",Jt,[e[27]||(e[27]=t("label",{class:"block text-lg font-medium mb-2"},"ä»‹ç´¹",-1)),$(t("input",{type:"text","onUpdate:modelValue":e[9]||(e[9]=l=>r.value.intro=l),class:"w-full p-2 border border-gray-300 rounded-md"},null,512),[[R,r.value.intro]])]),t("div",qt,[e[28]||(e[28]=t("label",{class:"block text-lg font-medium mb-2"},"æ™‚é–“",-1)),t("input",{type:"date",value:r.value.time?new Date(r.value.time*1e3).toISOString().split("T")[0]:"",onInput:ue,class:"w-full p-2 border border-gray-300 rounded-md"},null,40,Kt)]),t("div",Qt,[e[30]||(e[30]=t("label",{class:"block text-lg font-medium mb-2"},"SDGsæ¨™ç±¤*",-1)),t("div",Xt,[t("div",{class:b(["relative flex flex-wrap items-center gap-1 p-2 border border-gray-300 rounded-md min-h-[2.5rem]",{"border-red-500":f.value.tags}])},[(i(!0),n(B,null,M(W.value,l=>(i(),n("span",{key:l.value,class:"inline-flex items-center px-2 py-1 text-sm bg-blue-500 text-white rounded-full"},[t("span",{innerHTML:l.title},null,8,Yt),t("button",{onClick:k=>ge(l.value),class:"ml-1 text-white hover:text-gray-200"}," Ã— ",8,Zt)]))),128)),$(t("input",{type:"text","onUpdate:modelValue":e[10]||(e[10]=l=>L.value=l),onFocus:e[11]||(e[11]=l=>E.value=!0),onInput:ce,class:"flex-1 min-w-0 outline-none bg-transparent",placeholder:W.value.length===0?"æœå°‹SDGsæ¨™ç±¤...":""},null,40,es),[[R,L.value]]),f.value.tags?(i(),n("div",ts,[...e[29]||(e[29]=[t("i",{class:"fa-solid fa-circle-exclamation"},null,-1)])])):m("",!0)],2),E.value?(i(),n("div",{key:0,ref_key:"editDropdown",ref:G,class:"absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto mt-1"},[(i(!0),n(B,null,M(J.value,l=>(i(),n("div",{key:l.value,onClick:k=>de(l),class:"px-3 py-2 hover:bg-orange-300 cursor-pointer",innerHTML:l.title},null,8,ss))),128)),J.value.length===0?(i(),n("div",ls," ç„¡åŒ¹é…çš„æ¨™ç±¤ ")):m("",!0)],512)):m("",!0),f.value.tags?(i(),n("p",as," è«‹è‡³å°‘é¸æ“‡ä¸€å€‹SDGsæ¨™ç±¤ ")):m("",!0)])]),t("div",os,[e[31]||(e[31]=t("label",{class:"block text-lg font-medium mb-2"},"èƒŒæ™¯åœ–ç‰‡",-1)),t("input",{type:"file",onChange:re,accept:"image/*",class:"w-full p-2 border border-gray-300 rounded-md"},null,32),e[32]||(e[32]=t("p",{class:"text-sm text-gray-500 mt-1"}," é¸æ“‡æ–°åœ–ç‰‡ä¸Šå‚³ï¼Œå°‡æ›¿æ›ç¾æœ‰èƒŒæ™¯åœ–ç‰‡ã€‚ ",-1))]),t("div",{class:"flex justify-end gap-2"},[t("button",{onClick:ne,class:"px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600"}," å–æ¶ˆ "),t("button",{onClick:ie,class:"px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600"}," å„²å­˜ ")])])])):m("",!0)],32)}}},vs=Ke(ns,[["__scopeId","data-v-8f57e197"]]);export{vs as default};
